name: DEV APP

on: workflow_dispatch

jobs:
  build:
      runs-on: ubuntu-latest
      container:
          image: docker://fabernovel/android:api-29-v1.1.0
      steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-node@master
        - uses: actions/setup-python@v2

        - name: Create environment
          run: |
              echo "ENV=STAGING" >> .env.staging
              echo "BASE_URL=${{ secrets.URL_DEV }}" >> .env.staging
        - name: Use Node 14
          uses: actions/setup-node@v2
          with:
              node-version: '14'

        - name: Install yarn
          run: npm install -g yarn

        - name: Install firebase CLI
          run: npm install -g firebase-tools

        - name: Install dependencies
          run: yarn

        - name: Make Gradlew Executable
          run: cd android && chmod +x ./gradlew

        - name: Update gradle version for Android
          uses: damienaicheh/update-android-version-gradle-action@v1.0.0
          with:
              build-gradle-path: android/app/build.gradle
              version-code: ${{ github.run_number }}
              version-name: ${{ env.APP_VERSION_NAME }}
              print-file: true

        - name: Build Android App Bundle
          run: |
              cd android && ENVFILE=.env.staging ./gradlew assemblestagingRelease --no-daemon
        - name: Distribute app via Firebase App Distribution
          env:
            firebaseToken: ${{ secrets.FIREBASE_TOKEN }}
            firebaseGroups: ${{ secrets.FIREBASE_GROUPS }}
            firebaseAppId: ${{ secrets.DEV_FIREBASE_APP_ID }}
            notes: ${{ github.event.head_commit.message }}
          run: |
            yarn global add firebase-tools
            export PATH="$(yarn global bin):$PATH"
            firebase \
              appdistribution:distribute android/app/build/outputs/apk/staging/release/app-staging-release.apk \
              --app $firebaseAppId \
              --release-notes "$notes" \
              --groups "$firebaseGroups" \
              --token "$firebaseToken"
        - name: Send tele message
          uses: appleboy/telegram-action@master
          with:
            to: ${{ secrets.TELEGRAM_TO }}
            token: ${{ secrets.TELEGRAM_TOKEN }}
            format: markdown
            message: |
              ========
              🚀  [Test]
              🍺  DEV
              📌  Version: ${{ secrets.APP_VERSION_NAME }} (${{ github.run_number }})
              🧔🏻‍♂️  ${{ github.actor }}
              😃  Commit message: ${{ github.event.head_commit.message}}
              🪄 ${{ github.ref }}
                 Repository: ${{ github.repository }}
                changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}
